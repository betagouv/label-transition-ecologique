# Territoires en Transition

Dans le cadre des programmes d'accompagnement des collectivit√©s dans leurs d√©marches de transition √©cologique, l'[ADEME (l'Agence de la transition √©cologique)](https://www.ademe.fr/) s'est associ√©e √† [beta.gouv.fr](https://beta.gouv.fr/).

L'objectif : Aider les collectivit√©s √† prioriser la mise en ≈ìuvre des actions les plus impactantes pour r√©ussir la transition √©cologique.

## Description du service

### Une transition √©cologique lente et complexe

Les collectivit√©s ont un r√¥le central √† jouer dans la transition √©cologique. Elles poss√®dent les comp√©tences et l'influence sur de nombreuses activit√©s d√©terminantes pour la r√©ussite de la transition √©cologique.

Une majorit√© des collectivit√©s rencontrent des difficult√©s √† mettre en place des actions √† la hauteur des enjeux sur leur territoire. Au-del√† des diff√©rents blocages politiques, organisationnels et financiers, ces difficult√©s sont directement li√©es √† la complexit√© et transversalit√© des sujets de la transition √©cologique qui, pourtant, dans leur mise en oeuvre, ne sont port√©s que par quelques personnes au sein de la collectivit√©.

### Faciliter et acc√©l√©rer la mise en oeuvre des actions de transition √©cologique

La plateforme num√©rique a pour objectifs de faciliter et d'acc√©l√©rer la mise en oeuvre des actions ayant le plus d'impact pour la r√©ussite de la transition √©cologique au sein d'une interface permettant :

- D'acc√©der aux r√©f√©rentiels d'actions de transition √©cologique (Climat-Air-√ânergie (aussi connu comme la labellisation Cit'ergie) et √âconomie Circulaire) et de personnaliser leur utilisation
- De g√©rer et suivre ses actions et indicateurs de transition √©cologique
- De prioriser les actions ayant le plus d'impact
- De partager la progression des r√©alisations et des retours d'exp√©riences entre collectivit√©s

## Organisation du d√©p√¥t

Ce d√©p√¥t Git contient :

- 3 services :
  - le ["data-layer"](./data_layer)
  - le ["business"](./business)
  - le [client](./app.territoiresentransitions.react)
- les donn√©es des r√©f√©rentiels en [markdown](./markdown)
- le [code du site statique](./packages/site)
- les [composants partag√©s](./packages/ui) entre le client et le site

Chaque dossier √† la racine contient son propre `README.md` et peut a priori fonctionner de mani√®re autonome.

Vous pouvez contribuer √† notre projet [en suivant cette documentation](docs/workflows/contribuer-au-projet.md).

# Conception

La conception, des donn√©es au choix de la stack.

## Donn√©es

### Les donn√©es m√©tier

Les contenus de notre application sont √©crits en markdown, ce faisant les experts m√©tiers travaillent dans le m√™me d√©p√¥t
que les devs.

Ces fichiers markdowns repr√©sentent des d√©finitions auxquelles sont rattach√©es des donn√©es provenant d'utilisateurs. Par
exemple un indicateur tel que [Emissions de GES](markdown/indicateurs/crte/crte_001.md)
est destin√© √† permettre aux utilisateurs √† saisir leurs donn√©es annuelles dans notre application.

Ces d√©finitions sont lues par la partie [referentiel](business/business/referentiel/README.md) du `business` et sauvegard√©e en
base afin d'√™tre

- utilis√©es pour le processus d'[√©valuation](./business/business/evaluation/README.md)
- affich√©es dans le `client`
- utilis√©es comme garantie de la coh√©rence des donn√©es utilisateur stock√©es dans le `data layer`

### Les donn√©es utilisateurs

Les utilisateurs saisissent pour le compte de leur collectivit√© des donn√©es qui sont stock√©es dans le `data layer` qui v√©rifie leurs droits en √©criture grace aux
[row security policies](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)

### Les donn√©es d'√©valuation

Les donn√©es utilisateurs rattach√©es aux r√©f√©rentiels sont √©valu√©es par le service √©valuation du `business` qui inscrit
les r√©sultats en base et les transmets au `client` via les WebSockets
de [supabase realtime](https://github.com/supabase/realtime)

## Design

L'application est compos√©e de trois √©l√©ments :
le `client`, le `data layer` et le `business`.

Chacun de ses √©l√©ments a un p√©rim√®tre d√©finit :

- le `client` permet aux utilisateurs de se servir du produit et ne communique qu'avec le `data layer`
- le `data layer` se charge des donn√©es et de l'authentification.
  - Il permet au `client` de stocker les donn√©es de fa√ßon s√©curis√© et lui fournit les moyens via une API REST de lire
    les donn√©es simplement en lui fournissant des endpoints adapt√©s.
  - Il permet au `business` de stocker les donn√©es m√©tier et d'acc√©der aux donn√©es utilisateurs
  - Dans le processus d'√©valuation, il permet au `business` de r√©agir aux changements des donn√©es utilisateur et au
    `client` de r√©agir aux changements des √©valuations.
  - Enfin, il garantit la coh√©rence des donn√©es.
- le `business` se charge des parties m√©tier et ne communique qu'avec le `data layer`
  - il lit les contenus markdown et les enregistre dans le `data layer`
  - il √©value les donn√©es utilisateur et les enregistre dans le `data layer`

## Stack

- Le `client` utilise React ce qui nous permet de b√©n√©ficier d'un √©cosyst√®me riche. Il est d√©velopp√© en TypeScript.

- Le `data layer` utilise [Supabase](https://github.com/supabase/), une solution qui int√®gre tous
  les [services](https://supabase.com/docs/architecture) dont nous avons besoin en open source dont :

  - [gotrue](https://github.com/netlify/gotrue) pour l'authentification OAuth2
  - [PostgreSQL](https://www.postgresql.org/) la base qui nous apporte le typage et la consistence des donn√©es.
  - [PostgREST](https://postgrest.org/en/stable/) qui transforme la base de donn√©e en une API RESTful.

- le `business` est d√©velopp√© en Python üêç.

## Lancer le projet en local pour le d√©veloppement

### D√©pendances

- Docker, permet de lancer les conteneurs qui composent le produit. Installation simple avec [Docker Desktop](https://docs.docker.com/desktop/).
- [Earthly](https://earthly.dev/get-earthly) qui permet de lancer le projet et la CI en local comme en remote.
- [Supabase CLI](https://supabase.com/docs/guides/cli) pour lancer le datalayer et g√©n√©rer les types.

### Set up

Une fois les d√©pendances il suffit de lancer la commande `setup-env` avec `earthly` pour configurer les variables d'environnement de chaque projet.

```shell
earthly +setup-env
```

### Lancer les diff√©rents services en local

Pour lancer les services en local avec docker, on utilise la commande `dev` :

```shell
earthly +dev
```

Par default le client (`app`) n'est pas lanc√©, on peut n√©anmoins sp√©cifier les options suivantes :

- `stop` : commence par stopper les services.
- `datalayer` : lance supabase.
- `business` : build et lance le business.
- `app` : build et lance l'app

On peut √©crire par exemple :

```shell
earthly +dev --stop=yes --datalayer=yes --business=yes --app=no
```

### Lancer les tests

Les trois services sont des projets ind√©pendants qui peuvent-√™tre test√©s en local sous reserve que les d√©pendances de
d√©veloppement soient install√©es.

N√©anmoins, on peut lancer les tests avec `earthly` en utilisant des conteneurs :

```shell
# Lance le projet suivi de tout les tests.
earthly +dev

# Lance les tests ind√©pendamment
earthly --push +db-test
earthly --push +business-test
earthly --push +app-test
earthly --push +api-test
earthly --push +deploy-test
```

## D√©ploiement

Aujourd'hui le `business` et le `client` sont d√©ploy√©s chez [Scalingo](https://scalingo.com/), le `data layer` est chez [Supabase](https://supabase.com/) en mode BaaS.

## Workspaces NPM

Les [workspaces NPM](https://docs.npmjs.com/cli/v10/using-npm/workspaces) sont utilis√©s pour partager du code entre diff√©rents modules _front_ du projet (`ui`, `app` et `site`).

Tous les modules du projet utilisent l'espace de nommage `@tet` (exemple: `@tet/app` pour l'application).

Les chemins des workspaces sont list√©s dans la propri√©t√©s `workspaces` du fichier `package.json` √† la racine du d√©p√¥t.

Dans ce contexte les diff√©rentes commandes NPM habituelles peuvent √™tre lanc√©es depuis le r√©pertoire racine en pr√©cisant avec l'option `-w` (ou `--workspace`) le(s) workspace(s) dans le(s)quel(s) la commande doit s'ex√©cuter.

Exemples :

- Installer les d√©pendances pour les modules `ui` et `site` : `npm i -w @tet/ui -w @tet/site`

- Ajouter une d√©pendance externe dans le module `app` : `npm i <nom-module-npm-externe> -w @tet/app`

- Ajouter une d√©pendance interne dans le module `app` : `npm i @tet/<nom-module-interne> -w @tet/app`

- Lancer le serveur de d√©veloppement du module `ui` : `npm run dev -w @tet/ui`

Les modules `site` et `app` √©tant d√©pendants du module partag√© `ui`, des commandes permettant de lancer en parall√®le les serveurs de d√©veloppement sont disponibles √† la racine du projet.

- D√©marrer les serveurs de dev `ui` et `app` : `npm run dev:app`

- D√©marrer les serveurs de dev `ui` et `site` : `npm run dev:site`

- D√©marrer les serveurs de dev `ui`, `app` et `site` : `npm run dev`

De la m√™me mani√®re pour faire le build de production du site et de l'app il faut aussi faire le build des modules partag√©s.

- Faire le build de production de `app` : `npm run build:app`

- Faire le build de production de `site` : `npm run build:site`

Enfin pour faire le build depuis Scalingo la variable d'environnement `SCALINGO_BUILD` est attendue pour contr√¥ler le fonctionnement de la commande `npm run build`.

- Lorsque la variable est renseign√©e, les d√©pendances n√©cessaires au build sont install√©es.

- Lorsque la variable vaut `site`, la commande `build:site` est lanc√©e, et sinon la commande `build:app`.
